# 请确认如果使用不同配置，[save_variables] 必须在 [ace] 上方
[save_variables]
# 保存变量文件路径 - 存储打印机状态变量
filename: ~/printer_data/config/saved_variables.cfg

[respond]
# 响应模块 - 用于GCODE命令的响应处理

[ace]
# Anycubic Ace Pro 多色系统配置
# 串行端口 - 连接Ace Pro设备的串口
#serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
serial: /dev/ttyACM0
# 波特率 - 通信速率
baud: 115200
# 默认送料速度 - 加载耗材速度(80 mm/s)，原厂建议10-25
feed_speed: 80
# 默认回抽速度 - 卸载耗材速度(80 mm/s)，原厂建议10-25
retract_speed: 80
# 换料回抽长度 - 换料时回抽耗材距离(150 mm)
toolchange_retract_length: 150
# 工具头传感器到喷嘴距离 - 已注释，使用下面的50mm设置
#toolhead_sensor_to_nozzle: 62
# 换料加载长度 - 换料时加载新耗材距离(630 mm)
toolchange_load_length: 630
# 鲍登管长度 - Ace Pro与分流器之间的管长(默认1000mm)
bowden_tube_length: 1000
# 停靠到工具头撞击次数 - 默认5，如果设置稳定可降低
#park_hit_count: 16
# 最大干燥温度 - 耗材干燥器最高温度(55°C)
max_dryer_temperature: 55
# 换料后禁用送料辅助 - 默认为true
#disable_assist_after_toolchange: true
# 工具头传感器到喷嘴距离(50 mm)
toolhead_sensor_to_nozzle: 50
# 挤出机传感器引脚 - 检测挤出机中是否有耗材
extruder_sensor_pin: PE9
# 工具头传感器引脚 - 检测工具头位置，使用额外MCU的PA3引脚
toolhead_sensor_pin: EBBCan:PA14

[gcode_macro CUT_TIP]
# 切割耗材尖头宏 - 自动修剪耗材末端
gcode:
    # 响应信息：正在切割...
    RESPOND TYPE=echo MSG="CUTING..."
    # 如果XYZ轴未回零，则执行回零
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    # 保存当前G代码状态
    SAVE_GCODE_STATE NAME=my_move_up_state
    # 显示屏显示：Cutting
    M117 Cutting
    # 移动到切割位置
    G1 X25 F6000
    G1 Y0 F6000
    M400  # 等待所有移动完成
    # 执行切割动作（来回移动）
    G1 X10 F600
    G1 X25 F6000
    G1 X10 F600
    G1 X25 F6000
    M400
    # 强制挤出机回抽50mm
    FORCE_MOVE STEPPER=extruder DISTANCE=-50 VELOCITY=10
    # 显示屏显示：CUT DONE...
    M117 CUT DONE...
    M400
    # 响应信息：切割完成
    RESPOND TYPE=echo MSG="CUT DONE"
    # 恢复之前保存的G代码状态
    RESTORE_GCODE_STATE NAME=my_move_up_state MOVE=1 MOVE_SPEED=200

[gcode_macro _ACE_PRE_TOOLCHANGE]
# 换料前预处理宏
# 定义最小清洗温度变量
variable_purge_temp_min: 240
gcode:
    # 响应信息：执行换料前准备
    {action_respond_info("Doing Pre toolchange")}
    # 保存当前G代码状态
    SAVE_GCODE_STATE NAME=TOOLCHANGE
    # 如果XYZ轴未回零，则执行回零
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    # 切换到相对坐标模式
    G91
    # Z轴向上移动2mm
    G1 Z2 F100
    M400
    # 切换回绝对坐标模式
    G90
    # 移动到换料位置
    G1 X150 Y5 F6000
    M400
    # 检查挤出机温度，如果低于最小清洗温度则等待加热
    {% if printer.extruder.temperature < purge_temp_min %}
	{% if printer.extruder.target < purge_temp_min %}
          # 设置温度并等待达到
          M109 S{purge_temp_min}
        {% else %}
          # 等待温度达到最小值
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={purge_temp_min}
        {% endif %}
     {% endif %}

    # 重置挤出机坐标（已注释）
    #G92 E0
    # 响应信息：执行换料
    {action_respond_info("Doing Toolchange")}

[gcode_macro _ACE_POST_TOOLCHANGE]
# 换料后处理宏
gcode:
    # 响应信息：执行换料后处理
    {action_respond_info("Doing Post toolchange")}
    # 切换到相对坐标模式
    G91
    # Z轴向下移动2mm
    G1 Z-2 F100
    M400
    # 切换回绝对坐标模式
    G90
    # 清洗喷嘴（已注释）
    #G1 X300 Y356 F1200
    #G1 X320 Y356 F1200
    #M400
    # 恢复换料前保存的G代码状态
    RESTORE_GCODE_STATE NAME=TOOLCHANGE MOVE=1 MOVE_SPEED=200
    # 响应信息：换料完成
    {action_respond_info("Finish Toolchange")}

[gcode_macro _ACE_ON_EMPTY_ERROR]
# 耗材用尽错误处理宏
gcode:
    # 响应信息：线轴已空
    {action_respond_info("Spool is empty")}
    # 如果当前正在打印，则暂停打印
    {% if printer.idle_timeout.state == "Printing" %}
        PAUSE
    {% endif %}

# 以下为工具切换的快捷命令宏
[gcode_macro TR]
# 回抽工具宏
gcode:
    ACE_CHANGE_TOOL TOOL=-1

[gcode_macro T0]
# 切换到工具0宏
gcode:
    ACE_CHANGE_TOOL TOOL=0

[gcode_macro T1]
# 切换到工具1宏
gcode:
    ACE_CHANGE_TOOL TOOL=1

[gcode_macro T2]
# 切换到工具2宏
gcode:
    ACE_CHANGE_TOOL TOOL=2

[gcode_macro T3]
# 切换到工具3宏
gcode:
    ACE_CHANGE_TOOL TOOL=3
